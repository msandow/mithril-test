<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Mithril Test</title>
  
  <link rel="stylesheet" href="css/app.css">

  <script>
    window.token = "#{csrf}";
  </script>
  <script src="mithril.min.js"></script>
  <script src="js/app.js"></script>
  <script>
    m.ready(function(){
      var Utils = {
        constructAppLink: function(str){
          return '#' + str;
        },
        destructAppLink: function(str){
          return str.substring(1);
        }
      };
      
      var App = {
        view: function(){},
        controller: function(){
          m.route("/home");
        },
        route: "/"
      };
      
      m.register(App);
      
      var Navigation = {
        controller: function(args){ 
          this.links = [
            {
              text: 'Home',
              url: '/home'
            },
            {
              text: 'Account',
              url: '/account'
            }
          ];
        },
        view: function(ctx, args){
          return m.el('nav',{
            onclick: function(evt){
              evt.preventDefault();
              m.route(Utils.destructAppLink(evt.target.getAttribute('href')));
              return false;
            }
          },ctx.links.map(function(l){
            var configs = {
              href: Utils.constructAppLink(l.url),
            };
            if(l.url == args.url){
              configs.style = {};
              configs.style["font-weight"] = 'bold';
            }

            return m('a',configs,l.text);
          }));
        }
      };
      
      var LoadingScreen = m.component({
        controller: function(){
          this.active = true;
        },
        view: function(ctx){
          if(ctx.active){
            return m.el('p','Loading...');
          }
          
          return null;
        }
      });
      
      var Home = {
        controller: function(){
          var self = this;
          this.navigationPanel = m.component(Navigation, {url: m.route()});
          this.counter = 0;
          this.isLoading = true;
          
          var request = m.ajax({
            type:'GET',
            url: '/getNumber',
            complete: function(error, response){
              self.isLoading = false;
              
              if(!error){
                self.counter = response.number; 
              }
            },
            headers: {
              foo: 'bar'
            }
          });
          request.abort();
          this.message = "Welcome back";
        },
        view: function(ctx){
          return m('section',[
            ctx.navigationPanel(),
            m.el('span',{
              onclick: function(){
                ctx.counter++;
              }
            }, ctx.message + ' ' + ctx.counter),
            (ctx.isLoading ? LoadingScreen() : null)
          ]);
        },
        route: "/home"
      };
      
      m.register(Home);
      
      var Account = {
        controller: function(){
          this.navigationPanel = m.component(Navigation, {url: m.route()});
          
        },
        view: function(ctx){
          return m('section',[
            ctx.navigationPanel(),
            m.el('h2','Account')
          ]);
        },
        route: "/account"
      };
      
      m.register(Account);
      
      m.start(m.query('body'));
    });
  </script>
</head>

<body>
  
</body>
</html>