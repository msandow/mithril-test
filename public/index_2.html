<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Mithril Test</title>
  <!--
  <link rel="stylesheet" href="css/styles.css?v=1.0">
  -->
  <script src="mithril.min.js"></script>
  <script src="mithril.factory.js"></script>
  <script>
    window.onload = function(){
      
      var components = {
        link: function(href, text, conf){
          conf = conf || {}
          var ooc = conf.onclick || function(){}
          conf.onclick = function(evt){
            evt.preventDefault();
            m.route(href);
            ooc();
          };
          conf.href = href;
          
          return m.el("a", conf, text);
        }
      };

      var Navigation = m.create({
        name: "Navigation",
        model: function(){
          this.links = [{text: 'Home', link: '/home'},{text: 'About', link: '/about'}];
        },
        controller: function(){
          m.on(document.querySelector('#nav'), 'mouseenter', 'a', function(){
            console.log(this);
          });
        },
        view: function(ctrl){
          return Navigation.model.links.map(function(l){
            var li = components.link(l.link, l.text);

            if(m.route() === l.link){
              li.attrs.style = 'font-weight:bold';
            }

            return li;
          });
        }
      });
      
      m.register(Navigation);

      var Empty = m.create({
        name: 'Empty',
        path: '/'
      });  

      m.register(Empty);
      
      var simple = function(name, route){
        var newModule = m.create({
          name: name,
          path: route,
          model: function(){
            this.toggle = false;
            this.text = '';
          },
          unload: function(){
            console.log(this)
          },
          controller: function(){
            setTimeout(function(){
              m.startComputation();
              newModule.model.text = name;
              m.endComputation();
            },500);
          },
          view: function(ctrl){
            return [
              m.el('h4',(newModule.model.toggle ? '- ' : '') + newModule.model.text),
              m.el('a[href="#"]', {
                onclick: function(evt){
                  evt.preventDefault();
                  Navigation.model.links.push({text: 'Return', link: '/home'});
                }
              }, 'push')
            ];
          }
        });

        return m.register(newModule);
      };

      simple('Home', ['/home','/homeagain']);
      simple('About', '/about');

      m.renderModule(document.querySelector('#nav'), Navigation);
      m.buildRoutes(document.querySelector('#body'));

    };
  </script>
</head>

<body>
  <nav id="nav"></nav>
  <section id="body"></section>
  
</body>
</html>